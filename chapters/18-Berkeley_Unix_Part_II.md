# 伯克利Unix 第二部分

1978年早期，Richard Fateman教授开始寻找一个有更大内存寻址空间的机器，这样就能在PDP-10上继续做他的Macsyma。Fateman解释说:

> MIT有一个MAC项目，它的程序叫做MACSYMA。为了和VAX只最初只能PDP-10上运行的那个同名项目区分开，我就叫它VAX/Macsyma，有时也会说成vaxima。MIT后来将Macsyma卖了出去，从它的名字也可以看出来，它被卖给了Symbolics公司。接下来所有的后续版本都不被Symbolics所控制，也不被再接下来的所有者马萨诸塞州阿灵顿的Macsyma公司控制，这些版本被称为和Macsyma不一样的名字:

> DOE-Macsyma —— (能源部的版本)
> Paramax —— (Paradigm Associates)
> Maxims —— (德克萨斯州立大学Bill Schelter移植的通用Lisp版本)
> Aljabr —— (Jim O’Dell开发的Macintosh版本)

> 所有这些分支版本在本质上都和vaxima差不多，虽然它们的支持者都声称自己选择了最好的。

不管怎么说，新的DEC VAX 11/780机器看起来符合Fateman的需求，而且Fateman关于NSF的提议和其他13位教员的建议一起得到了部门基金。最初VAX运行的是DEC的VMS操作系统。

但是部门开始变得习惯使用Unix，并且Fabry得到了一份Unix 32V移植到VAX的拷贝，这是霍姆德尔贝尔实验室的John Reiser和Tom London开发的。移植项目的主管是Charlie Roberts，这些是他回忆的那段故事:

> 77年到78年DEC提前宣布了VAX。Dennis和Ken还有Steve和DEC公司变得相当疏远。他们觉得自己的工作已经安装在很多的机器上，DEC仍然拒绝支持Unix并且继续开发VMS。所以当DEC提供给他们一台VAX的时候，他们拒绝了(Doug McIlroy告诉我他们拒绝的另一个原因是“VAX使用让人非常厌烦的复杂指令集，这于Ken和Dennis的价值观非常不一致”)。之后Dennis和Steve为移植到Interdata上工作，Steve称它为“Intersnial”。

> 因此DEC去霍姆德尔找到了我们。显然我们是后备人选。Tom London和John Reiser对此很有兴趣，Ken Swanson也是，我们在78年早期拿到了VAX机器。我不做任何技术工作。实际上，我花费了大量的时间和精力让管理层同意我们做这个。你看，这不是研究。最后管理层给了我们一点时间。大概用了3个月的时间我的小组将第7版Unix一直到了VAX。我们在1月得到机器，然后在4月让它运行起来，8月的时候它就可以真正的工作了。接下来的事情大家都知道了，大约有6个大学给我打了电话——布朗大学，加州大学，伯克利大学，滑铁卢大学，其他的我已经记不起来了。所以我为了专利和授权去见Roy Lipton和Al Arms，经过不断地反复，他们决定我们可以将给大学作为研究途径使用，Al将会和大学签订一份“特别研究协议”。

> 我在一些会议上见了Fabry，我那时去伯克利和Ferrari，Emmannuel Blum和Bill Joy做论文和演讲。所以在贝尔实验室11区管理部门的祝福下，我将32V给了伯克利，时间是1978年11月。

批准了Roberts合作的管理层是C.C. Cutler，R.W. Lucky，和W.S. Boyle。1127管理层——Doug McIlroy，Sam Morgan，以及Bob Prim也批准了。

1979年32V成为了3BSD。Kirk McKusick向Peter Collinson描述了故事情节:

> 当Ken离开这里回贝尔实验室去的时候，他留下了一份Unix系统。Bill和Chuck Hale接管了这个系统的开发。那时候他们做的是像升级到第6版和集成实验室的“50 fixes”纸带之类的事情。后来他们又将它升级到第7版。

> Bill又在实用工具方面做了很多工作。他厌倦了shll，将John Mashey在PWD中关于shell的一些点子添加到**csh**中。Bill也对**ed**很有些意见，所以决定开发一个扩展的面向行的编辑器**ex**。然后我们将我们的几个终端从没有鼠标定位的ADM-3s升级到具备此功能的ADM-3a。只有Bill和那个房间里的两个人真的喜欢用他们。他开始了**vi**的开发，因此他总是有理由将正在使用新终端的人赶走。最初的**termcp**也被发明出来，这样就可以在不同的ADM终端上运行一样的编辑器。

> 关于**vi**为什么没有多窗口模式还有一个寓言故事。Bill编写调试代码终于使它勉强可以工作，但这时候突然有一个磁盘坏掉了。这个有窗口版本的磁盘没有被即时备份，备份好的只是没有窗口的代码，他也不想再去从写开发一遍。

> 最初的伯克利软件发行版，叫做BSD而不是1BSD，它包含了Pascal系统和**ex**。Bill除了是一个天才的程序员，还是一个天才的市场销售。他做了很多通俗易懂的演讲告诉人们这个东西是多么的棒，Pascal解释器是如和做到只花费C语言编译器十分之一的时间，并且它还有错误纠正功能，所以它更时候学生因为可以给他们更多的额支持。他卖出了大概35份BSD纸带，每份定价是“只是成本价”的35美元(原价50美金)。BSD发行版的关键是Bill，他是黑客，是电话客服，是纸带绕带员，他将地址写在标签上，将它们寄出去，他做了所有的事情。

> 接下来就是2BSD，它在大约一年以后出现，包含了Pascal系统，**ex**，**vi**，和**csh**。他单枪匹马做了这些并且在那年卖出了100份...

> 2BSD将是基于V7的，因为我们是在1978年拿到了预发布的UNIX/32V。V7由此一直到了VAX。它没有分页和其他什么特点，它只是一个在VAX上运行的基于交换的传统UNIX。我们有一个编号非常小的VAX-11/780，一个个位数的编号。

> Bill要做的第一件事就是让32V在VAX上跑起来，这需要你的机器使用和发行版纸带有完全相同的硬件，那时还没有auto-configuration的概念。你不得不做到硬件和他们完全一致，不能是丝毫的差异。正好我们有两盘磁盘，正好它们都是RP06s。

> 下一件要做的事情是移植使用工具。我曾经为Pascal解释器做过一些事情，添加一些新的功能和修改一些不太对的地方。Bill对我说“你为什么不把解释器移植过来?”。

> Pascal解释器是用汇编写的，“移植它非常简单，它只有很少的操作步骤并且汇编语言看起来几乎都一样”。他做了一点小例子向我证明这事做起来很简单。我花了一个月的时间做移植工作，最后我放弃了汇编，用C语言重写了解释器。

> 还有一个问题，VAX只有2MB的内存...这台机器的硬件有个巨大的进步，你可以在它上面使用虚拟内存。Babaoglu和Domenico Ferrari一起为VAX设计了一个分页系统。Bill在听说了一些他们的工作后就帮他将这个功能运行起来。经过78年12月到79年七月的假期，他们让VAX-11/780实现了独立，这样它就可以启动不同的系统了。你登陆进去后，有一个提示语告诉你“虚拟VAX Unix”，然后系统要卡顿一会，你可以先做些别的工作。经过5分钟的等待，系统会提示它现在是32V。

> 它起初并不是很稳定，但是最后他们让它变得很健壮，它成了一个基础系统。

> Bill决定停止做只有使用工具的发行版，转而去做包完善的系统。他创建了3BSD发行版，这是一个完善的系统，带有基于虚拟内存的内核和移植过来的使用工具。这也是一个完善的可启动系统，在纸带的起始部分是一个启动块，你可以把纸带放在原始的硬件上就可以启动。他还为这个发行版做了其他所有的系统。

> 那时我开始将越来越多的系统花费在内核问题上。我记得有一件事情让我参与进来。Bill试着调试虚拟内存系统，他将这个巨大的程序打印出来，足足有一英尺半那么厚。他把代码搬过来放在桌上，以他特有的热情开始翻看代码。他一遍又一遍的翻看，“在这页有一个bug导致了竞争状态，我给找出问题的人20美元”。

> 我从来没有呀看过内核的源代码，但是我上过操作系统课程，所以我知道竞争状态的出现是因为你在某些地方使用了上下文切换。我看着这些写的很标准的代码，在在这页上一共有两个子例程的调用。我指着这两个调用问是不是其中的一个做了上下文切换。“是的！就是它”，他跑出房间，留下一片片飞在空中的纸张。和Bill在一个办公室工作是一件困难的事情，你很难不被他的热情所感染。

> 3BSD系统发布出去后受到了很多关注，因为不少大学都购买了VAX机器。你如果想要一个分页系统，那么只有3BSD和VMS两个选择。很多人既想用Unix又想要分页的功能，所以3BSD在VAX早期的购买者中非常流行。

关于这个还有个小故事，McKusick告诉我:

> 债务被拖欠了一年又一年。Bill去了Sun公司，他成了一个百万富翁。四五年前，当UNIX国际组织成立的时候，他们试着做一些宣传，于是去了一个很有影响力的新闻发布会UniForum宣布了他们的存在(1989年1月在旧金山)。他们决定向Unix商业中的杰出人物们颁发一个产业奖项，记者们就可以看到这些产业明星。他们提名了几个人——毫无悬念的包含Dennis和Bill，我也被包含进名单。在他们向我们讨论这件事之前，我们赚的很少。我告诉他们我是如何参与到Unix的故事，他们都大笑起来。但是在有像Dennis Ritchie这样重要人员在场的会议上，他们做了什么？他们直接讲了那个故事。那时Bill正在台上拿着他的奖牌。他们说:“Kirk说他从来没有付钱”。就在我走到Bill Joy后面的时候，他从口袋里掏出50美分，摇晃着他们说‘这就是你想要的二十美元！’。后来我问他“Bill，他们之前告诉过你会发生这些事情吗”，他说“当然没有，如果他们警告过我，那我就会准备20美元”。

Keith Bostic通过NET2的发布将伯克利Unix开发的历史描绘在一起，这是他的大纲:

1. 早期在伯克利运行的系统是Unix第5版，第6版和第7版，这些都是来自贝尔实验室。这些系统在伯克利被计算机中心和EECS部门不停的修改。这些修改包括:
2. 伯克利Pascal——大约1977年伯克利为在PDP-11上运行的第6版Unix写的软件
3. 2BSD——1978年开始伯克利为第6版和第7版发行版写的软件。新的软件和修改一次又一次的添加进来，包含mail，more，csh，ex，以及vi，Pascal。2BSD使用了第6版和第7版不同的授权。
4. 3BSD，1979年晚期——这是第一个针对VAX的伯克利发行版。它基于32V，带有伯克利使用工具和来自2BSD的修改，加上Bill Joy和几个毕业上完成的一个虚拟内存系统。

从1969年开始到第6版Unix这段时间只有一个解释器，就是Shell。73年4月18日出版的入门手册一共只有三页。随着Bournes的Shell集成到第7版Unix和Joy的C Shell集成到2BSD，程序员们有了一个选择。1980年中期AT&T贝尔实验室的David Korn发明了Korn shell，给了程序员所期望的更多选择。1986年它被包含在“实验工具箱”中，1989年正式成为SVR4发行版的一部分(1988年911月16日发布)。通常Bournes shell向上兼容Korn shell。还有很多其他的shell，但是sh，csh和ksh是最常用的。

Unix可以运行在不止一台机器上的特点引起了美国国防高级项目局(DARPA)的主意。DARPA的几个合作单位使用了不同硬件和各种操作系统，而且软件都是互相不兼容的，做不到软件互换。DARPA想要一个统一的环境，所以会有很多的交换。McKusick告诉我“很显然他们会选择VAX，接下来的问题是他们的操作系统会选择VMS还是Unix”。他告诉Collinson:

> 
