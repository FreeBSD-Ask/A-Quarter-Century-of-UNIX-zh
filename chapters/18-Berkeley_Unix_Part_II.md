# 伯克利 Unix 第二幕

1978 年初，Richard Fateman 教授开始寻找一台具有更大地址空间的机器，以便他能继续在 PDP-10 上开始的 Macsyma 项目。法特曼解释道：

麻省理工学院的 MAC 项目中的程序叫做 MACSYMA。为了区分仅在 PDP-10（以及某种程度上在 Multics 系统上）运行的原始版本和 VAX 版本，我称后者为 VAX/Macsyma，有时缩写为 vaxima。麻省理工随后将 Macsyma 程序及其名称出售给了 Symbolics 公司。此后，所有不在 Symbolics 或其继任者——位于马萨诸塞州阿灵顿的“Macsyma Inc.”直接控制下的版本，都被称为除 Macsyma 之外的其他名称。

>* DOE-Macsyma（DOE 即能源部）
>* Paramax（Paradigm Associates）
>* Maxima（由德克萨斯大学的 Bill Schelter 移植的 Common Lisp 版本）
>* Aljabr（由 Jim O'Dell 制作的 Macintosh 版本）
>
>所有这些衍生版本本质上彼此相似，也与 vaxima 相似，尽管每个支持者都会声称其优越性。

筹集了一份 NSF 资助申请，准备与系里的资金合并使用。最初，VAX 运行的是 DEC 的 VMS 操作系统。

但系里已经习惯了 Unix，Fabry 获得了一份由 John Reiser 和 Tom London 在 Holmdel 的 BTL 完成的 Unix 32V 版本移植到 VAX 的副本。这个移植项目的负责人是 Charlie Roberts，下面是他讲述的故事：

>在一九七七到一九七八年间，DEC 预先发布了 VAX。Dennis、Ken 和 Steve 对 DEC 感到相当疏远。他们觉得自己的工作卖出了很多机器，但 DEC 仍然拒绝支持 Unix，反而继续推进 VMS 这个项目。所以当 DEC 提供给他们一台 VAX 时，他们干脆拒绝了。\[Doug Mcllroy 告诉我另一个原因是“VAX 有一个令人反感的臃肿指令集，充满了与 Ken 和 Dennis 的价值观背道而驰的无关内容。”] 不管怎样，Dennis 和 Steve 正在做 Interdata 的移植，Steve 称它为 “Intersnail（慢速蜗牛）”。
>
>于是 DEC 找到了我们在 Holmdel。显然我们是第二梯队。Tom London 和 John Reiser 还有 Ken Swanson 都对此感兴趣，我们在一九七八年初拿到了 VAX。我没有参与任何技术工作，实际上，我花了大量精力和时间去说服管理层让我们做这件事。你看，这不算是研究。但他们还是允许我们花时间去做。大约三个月后，我的小组将第七版 Unix 移植到了 VAX。我们一月拿到机器，四月让它运行起来，八月时真的能用了。到那时，大家都知道我们在做什么。我接到了大约六所大学的电话——Brown、UCLA、Berkeley、Waterloo，其他的我记不清了。于是我去找了专利和许可部门的 Roy Lipton 和 Al Arms，讨论如何发布。经过反复磋商，他们决定我们可以把它交给一所大学用于研究用途，Al 会和那所机构签订一份“特别研究协议”。
>
>我在几次会议上见过 Fabry，也曾去过 Berkeley 做过报告，与 Ferrari、Ernmanuel Blum 和 Bill Joy 交谈过。因此，在 BTL 区域 11 管理层的支持下，我们于一九七八年十月或十一月将 32V 版本送到了 Berkeley。

Roberts 的管理团队批准了这项工作，他们是 C.C. Cutler、R.W. Lucky 和 W\.S. Boyle。1127 部门的管理层——Doug Mcllroy、Sam Morgan 和 Bob Prim——也给予了批准。

正是这个 32V 版本在一九七九年演变成了 3BSD。Kirk McKusick 向 Peter Collinson 讲述了这个故事：

>当 Ken 离开回到 Bell Labs 时，他留下一套 Unix 系统。Bill 和 Chuck Haley 接管了这套系统的维护工作。当时他们做了升级，比如升级到第 6 版，并且整合了来自实验室的“50 个 Bug”修复磁带。后来他们又升级到了第 7 版。
>
>Bill 继续专注于工具方面的工作。他对 shell 感到厌倦，从 John Mashey 的 PWB shell 中借鉴了一些想法，开发出了 csh。Bill 也对 ed 感到厌烦，决定开发 ex，这是一个扩展的面向行的编辑器。后来，他们把几台终端从不支持光标定位的 ADM-3 升级到支持光标定位的 ADM-3a。房间里只有两台这种终端，而 Bill 非常喜欢用它们。他开始开发 vi，总是有借口把正在用新终端的人赶走。最初发明 termcap，就是为了让同一个编辑器能在这两种 ADM 终端上运行。
>
>有一个传说讲述了 vi 为什么没有多窗口功能。Bill 当时改写了代码，功能差不多实现了。后来磁盘崩溃了，而备份磁带里的版本没有包含窗口功能。他一直没来得及补上这个功能。
>
>最初的 Berkeley Software Distribution（BSD，不是 1BSD）包含 Pascal 系统和 ex。Bill 不仅是个非常有才华的程序员，同时也是个出色的市场营销者。他会发表激动人心的演讲，讲这些东西有多棒。比如 Pascal 解释器运行速度只有 C 编译器的十分之一，而且带有错误校正功能，对学生更友好，因为可以支持更多学生。他大约卖出了 35 盒 BSD 磁带，所谓卖出就是“以大约 35 美元的价格提供给用户”。\[实际价格是 50 美元。] 当时的 BSD 发行版就是 Bill 一个人——他是黑客、接电话的人、录音带操作员，他在标签上写地址，寄出磁带，样样亲为。
>
>2BSD 是随后发布的版本，大约在一年后发布，包含 Pascal 系统、ex、vi 和 csh。Bill 也是单枪匹马完成，并在一年内发出了大约 100 份。
>
>这应该是基于 V7 的，因为 1978 年我们拿到了 UNIX/32V 的预发行版本。它是 V7 移植到 VAX 上的版本。它没有分页功能，只是一个传统的基于交换的 Unix 系统运行在 VAX 上。我们拿到的是非常低序号的 VAX-11/780，序列号只有个位数。
>
>Bill 的第一个任务是让 32V 在 VAX 上运行。这相当简单，只要你的硬件与发行磁带上的完全一样。没有自动配置的概念。你必须拥有完全相同的设备，不能多也不能少。必须有两块磁盘，并且必须是 RP06。
>
>接下来就是移植工具。我一直在做 Pascal 解释器的一些改进，加了一些功能，补齐了一些不完善的部分。Bill 对我说：“你为什么不把解释器也移植过来呢？”
>
>这个解释器是用汇编语言写的，“其实很简单，操作不多，汇编代码看起来几乎一样。”他演示了几个示例，证明移植很容易。我花了一个月时间做这件事，最后我放弃了汇编语言，用 C 重新写了一遍。
>
>另一个问题是 VAX 只有 2MB 的内存……当时有很大推动力去真正使用机器上的虚拟内存硬件。Özalp Babaoğlu 和 Domenico Ferrari 设计了一个适用于 VAX 的分页系统。他请 Bill 帮忙启动并运行这个系统，因为那时 Bill 对这个系统已经略知一二。在 1978 年 12 月到 1979 年 1 月的假期期间，他们让 VAX11/780 独立运行，能够启动不同的系统。登录时会显示一个横幅“Virtual VAX Unix”，但系统不可避免地会卡住一段时间。等待大约 5 分钟后，系统会重新启动并显示为 32V。
>
>系统不断地来回切换，但假期结束时他们让它稳定运行，并成为基础系统。
>
>随后 Bill 决定不再发布仅包含工具的版本，转而打包完整系统。他创建了 3BSD 版本。这是一个完整的系统，带有基于虚拟内存的内核和已移植的工具。它是一个完整可启动的系统，磁带开头有启动区，可以直接安装到裸机上。Bill 仍然独自完成所有发布工作。
>
>与此同时，我开始更认真地参与内核相关工作。我记得促使我参与的事件。Bill 当时正试图调试虚拟内存系统的一部分。他随身带着厚厚一叠大约一英寸半厚的内核程序代码清单。他走进来，以他极具热情的风格，把代码清单摔在桌上，翻到某页。他在那页代码上画了圈又圈。“这页代码中某处有一个因竞态条件引起的错误，谁找到我就给 20 美元。”
>
>我之前从未看过内核源码，但我学过操作系统课程，知道竞态条件通常会在上下文切换时出现。我查看代码，发现很标准，只有两个子程序调用出现在这一页。我指着这两个调用问他是否有可能导致上下文切换。“就是它！就是它！”他说完就带着一串纸张冲出房间。在 Bill 的办公室里工作，很难不被他的热情感染。
>
>3BSD 系统发布后受到关注，因为许多大学开始采购 VAX 机器。如果想要使用分页系统，你只能运行 VMS 或 3BSD。很多人想用 Unix，同时也希望利用分页功能。因此，3BSD 在早期 VAX 机器的购买者中非常受欢迎。

这里有一个脚注。McKusick 告诉我：“这笔债务多年未还。Bill 后来去了 Sun，成了百万富翁。大约四五年前，UNIX International 成立时，他们想搞点宣传，准备在 UniForum（旧金山，1989 年 1 月）举行一个大型新闻发布会宣布他们的成立。他们决定给 Unix 业内的一些名人颁发行业奖，借此吸引媒体关注。他们提名了那些人——Dennis 和 Bill Joy，你懂的，‘召集惯犯’。不管怎样，我也被加进了名单。在活动之前，他们和我们聊了一些细节。我给他们讲了我怎么加入 Unix 的故事，大家都笑了。但到了颁奖那天，他们先颁给了像 Dennis Ritchie 这样的重要人物，最后轮到我了，他们读了那个故事。Bill 就站在台上拿着他的奖牌。他们说：‘Kirk 报告说他从没拿到过报酬。’我刚走到 Bill Joy 身后，他从口袋掏出一张 50 美元，亮了亮，说：‘这是你的 20 美元本金和利息！’然后我就坐下了。后来我问他，‘Bill，他们事先告诉你会这样吗？’他说，‘一点没告诉我，要是告诉我，我就拿着那张 20 美元了。’”

1980 年，是 Bill Joy 飞到新泽西，和 Steve Bourne 一起把 4BSD 带进了 Bell Labs。Joy 告诉我：“我们一夜之间完成的。决定在晚上 9 点开始，第二天早上人们到办公室就看到一个新的操作系统在运行。真是惊人。”确实如此。

Keith Bostic 整理了一份 Berkeley Unix 发展历史的概要，直到 NET 2 版本发布。这是他概要的开头部分。

>a) 伯克利早期运行的系统是第五版（Version 5，V5）、第六版（V6，大约1976年）和第七版（V7，大约1978年），均来自 Bell Labs。所有系统都运行在 DEC PDP-11 计算机的不同版本上。这些系统在伯克利计算中心和电气工程与计算机科学系不断进行了修改。修改内容包括：
>
>b) Berkeley Pascal 磁带，BSD——大约1977年，伯克利为在 PDP-11 上使用 V6 而编写并发布的软件。
>
>c) 2BSD——大约1978年开始由伯克利发布的用于 V6 和/或 V7 的软件。软件和修改内容不时增加，包括 Mail、more、csh、ex 和 vi、Pascal 软件等。2BSD 以不同版本发送给拥有 V6 和/或 V7 许可证的机构。
>
>d) 3BSD，1979 年末——这是首个面向 VAX 的伯克利发行版。它基于 32V，包含伯克利的工具和来自 2BSD 的修改，另外还有由包括 Bill Joy 在内的几位研究生完成的虚拟内存系统。

从 1969 年到 V6 版本，只有一个解释器，一个名为 Shell 的程序。第四版手册条目（日期为 1973 年 4 月 18 日）长达三页。随着 Bourne shell 在 V7 中和 Joy 的 C shell 在 2BSD 中的加入，程序员有了选择（尽管如果使用的是 System III，则没有选择权）。正如预期的那样，这引发了关于“选哪个？”的争论。在 1980 年代中期，AT\&T Bell Labs 的 David Korn 发明了 Korn shell。它于 1986 年被纳入“Experimental Toolchest”，并在 1989 年成为 USL 的 SVR4 发行版的一部分（版本日期为 1988 年 11 月 16 日）。一般来说，Bourne shell 向上兼容 Korn shell。还有许多其他类型的 shell，但 sh、csh 和 ksh 是最常见的。

Unix 能够运行于多种机器这一事实，引起了国防高级研究计划局（DARPA）的关注。DARPA 关注到他们的多个承包商使用不同的硬件和多种操作系统，而且软件无法互换——软件根本不兼容。DARPA 希望有一个共同的基础，以促进更多的软件互通。McKusick 告诉我，“很明显他们会选择 VAX，问题在于最终是选 VMS 还是 Unix 作为首选操作系统。”他告诉 Collinson：

>比尔设法说服了 DARPA，认为 Unix 是更好的基础，因为它能够迁移到其他系统上，这样他们就不会被困死在 VAX 上。鲍勃·法布里负责政治层面的说服，而比尔则负责技术层面。
>
>他们成功获得了 DARPA 的一笔重大合同，用于实现这些性能增强并添加一些其他必要的基础功能。承诺是这些改进会很快推出。因此，4BSD 在 DARPA 资助抵达伯克利后两个月内发布……这是 1980 年晚些时候的事情。

根据 Collinson 的说法，“4BSD 变得流行的原因是因为 VAX-11/750 发布了，而 4BSD 是唯一能在它上面运行的 Unix 系统。” McKusick 继续说道：

>DEC 的 Armando Stettner 促成了 Bill 飞到 Maynard 去见一台尚未发布的新 750 机型，代号 Comet。Bill 和 Armando 合作做了一些工作，确保 4BSD 能在这些 Comet 上运行，所以当 4BSD 发布时，大家都知道它能跑在 750 上，尽管 Berkeley 当时还没有这台机器。事实上，后来 750 成为了该系的主力机器，因为你可以花大约 15 万美元买一整组六台。\[参与者包括 Bill Joy、Bill Shannon 和 Armando。Armando 的故事在后面章节。]
>
>4.1BSD 是性能的巅峰，可以看作是 4.0BSD 的精细调优版，尤其针对 750 优化。4.1BSD 被带回 Bell Labs，成为第 8、9 和 10 版 Unix 的基础。也是那次在 1983 年 6 月多伦多 USENIX 会议上，Rob Pike 因为 Berkeley Unix 使用了 cat -v 功能而严厉批评的版本。（Pike 指责 Berkeley Unix 风格差，称其为“癌性增长”，并说“cat -v 被认为是有害的。”过去十年里，代码膨胀更加严重：V7 内核只有 40KB，而 Ritchie 告诉我第 10 版内核大约有 150KB。）Armando Stettner 指出，在 4.1BSD 和 V7 之间选择时，没有人愿意回到 V7。
>
>随着 DARPA 资金的到位，Fabry 给 Bill 提供了正式员工的薪水。支持人员开始出现，有人负责接电话、制作磁带和处理许可证。Bill 能专注于他想做的事情。项目开始扩展，Bill 雇佣了技术员工，最初是 Michael Toy，后来是 Sam Leffler。
>
>4.1BSD 到 4.2BSD 之间的工作正是 DARPA 介入的原因。他们想要一些关键的改进，比如一个能够利用超过磁盘带宽 5% 的文件系统，以及基于 TCP/IP 的网络系统。
>
>BBN 做了一个初步原型，交给了 Berkeley。Bill 立刻开始改写，因为它在 750 上以 56KB/秒运行以太网时，占用了 CPU 的 100%。对 BBN 来说，这个速度适合主干链路，但对于以太网来说完全不行。Bill 削减了代码，性能提升到了大约 700KB/秒。
>
>当 BBN 带着他们的“完成”版本回来时，Bill 拒绝接受，双方多年为哪个版本进入系统争执不休。最终 Berkeley 版本胜出。\[Ritchie 告诉我，当他在 DARPA 委员会时，这确实是个大问题，“每六个月我们都会说，使用 BBN 版本，但 Bill 总是说不。”]
>
>4.2BSD 的第三个重要组成部分应该是一个新的虚拟内存系统，支持共享的读写段等功能。
>
>系统里有些功能不是 Bill 觉得应该有的，而是指导委员会强制要求的。比如通过消息传递传递文件描述符就是这样一个例子，Bill 并不认同，但也只好接受。


