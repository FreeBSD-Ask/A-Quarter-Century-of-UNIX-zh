# PDP-11

Dennis Ritchie，Ken Thompson 和 Joe Ossanna 曾经多次试图说服贝尔实验室为研究小组购买一台计算机，但是在 69，70 年的时候一台计算机意味着十万美金的价格。尽管是做文件系统和相关工具的研究，但是计算机研究小组还是没有自己的计算机。他们试着让贝尔实验室购买一台 PDP-10，或者去租一台，但他们始终没有如愿。Dennis Ritchie 对 Peter Collinson 说：

> PDP-7 上的所有软件都是用汇编写的。TMG 是一个自顶向下的操作系统编译器，最早是由 Bob McClure 编写，Doug McIlroy 也实现了一个。我们的 PDP-7 上只有 4K 的内存供应用程序使用，显然不够用 PL/I。所以 Doug McIlroy 为 PDP-7 移植了 TMG。那时 Ken Thompson 决定我们不能有一个不提供 FORTRAN 编译器的操作系统，所以我们都坐下来通过 TMG 开发一个 FORTRAN 编译器，这些事情只花了大概一天就搞定了。接下来就出现了 B。B 是 BCPL 的一个精简版本。

BCPL(Basic Combined Programming Language，基础组合编程语言) 是 Martin Richards 在 1967 年“编写编译器和系统的辅助工具”。B 是 BCPL 的精简版本，它的名也同样精简了下来。

Richine 解释说：

> 那时候 (1968) 我加入到实验室，最早是和 Rudd Canaday 搭档。他曾经将 BCPL 编译器移植到通用电气的 GE-635 上的 GECOS 系统。那时他正在将 BCPL 移植到 Multics，所以我接触到了运行 BCPL 的 Multics。那是非常早的一个移植版本，我们移植后 Martin Richards 一直在持续改进它。

> 既然有了 BCPL，我们通过它写了一些简单的程序。在第一个 Unix 系统上面 B 是基于 BCPL 的精简编程语言。它作为一个解释器输出的并不是机器码，而是一种中间码。

> 它先是用 TMG 写成，然后就实现了自举。事实上这个语言的开发过程非常有趣。编译器不断地用尽机器所有内存，Ken 不得不修改编译器，但这又使得再添加新特性变得异常困难。之后他使用新架构才使得编译器变得小巧起来，添加特性也变得比较方便了。

> B 的确是 Unix 上面的第一个高级编程语言，有一些东西就是用它编写的。它一共有两个具体实现版本，其中一个输出基于栈中间码的普通解释器，另一个被称之为 vb(virtual B) 的版本可以将机器的 4K 内存分页映射，解释器因此可以使用大于物理内存的内存。那时我们的一个程序需要比物理内存大的多的内存，我们用 vb 实现了它。

Andrew Hume 告诉我说“B 语言一直使用到 1989 年，控制排字机的程序就是用 B 写的”。但硬件的种种限制还是让人沮丧。最后 Ossanna 建议购买一台 PDP-11/20 用于文书处理系统。Ritchie 说：“Lee McMahon 认为我们做的很好”。在他的努力之下 (和对文书处理的信心)，声学研究总监 Max Mathews 资助了种子资金。McIlroy 告诉我说“没有外部计算机科学的帮助，Unix 可能永远都不会诞生”。实验室的管理员认为文字排版是又用的项目，于是他们预定了 PDP-11。Ritchie 说：

> 我们在 1970 年夏天很早就拿到了 PDP-11，但只有处理器和内存运到，磁盘还没有过来。它的所有软件都是纸带方式输入，你只能用纸带输入东西，并且还没有操作系统。Unix 诞生的第一件事是在 PDP-7 上用 B 语言写的 PDP-7 汇编器编写 PDP-11 的跨平台汇编器。

> 我们拿到 PDP-11 的时候，只有很少一些特殊基础命令用 B 语言重写了。第一个完成的应用是 PDP-11 汇编器。还有一个很早期版本的 dc(desk calculator)，是事实上的第一个跑在 PDP-11 上的应用，在没有操作系统之前就存在了 (标准的“DEC 操作系统”从来没有安装到 PDP-11 上)。它是一个很原始的汇编器，其语法和 PDP-11 的原始指令集几乎没有区别。

> Unix 的诞生可以分为两个阶段。Ken 在还没有磁盘的时候就让他跑了起来，他把内存分为两大部分，一部分用来存放操作系统，另一部分存放一种内存磁盘。要想让这个系统运行，你需要使用纸带加载初始磁盘的代码，然后是加载操作系统代码。所以在有磁盘之前，就已经执行了 cp(复制文件)，cat(链接文件)，以及 ls(列出文件) 命令。

> 一旦有了真正的操作系统，就有了退步。B 语言版本的汇编器运行速度非常慢，他们只好用汇编语言重写。我猜测还有不少用 B 语言写的东西。其中较早的一个是展开文件名中星号和其他一些特殊字符的 global 命令。我不会忘了支持 global 的原因，他有点不太合理。当 shell 应用在传入的参数中发现了魔法字符，它就会调用另一个程序展开它们。程序的代码并不在 shell 程序里面，它是用 B 语言写成的。

Thompson 说当等待 PDP-11 的磁盘的到时候，它们把 PDP-11 放在旁边。然后它们把代码移植过去，在内存里运行了文件系统。

但当 PDP-11 启动起来后，为了可以编程还需要一个文本编辑器。麻省理工的 PDP-1 有一个名为 TECO 的编辑器。起初，这是 Tap Editor and COrrector 的缩写，后来变为 Text Editor and COrrector。TECO 是 EMACS(Editing MACroS) 的前身。1967 年 L.P.Deutsch 和 B.W.Lampson 在 SDS-940 上面开发了一个名为 QED(Quick EDitor) 的 TECO 实现。SDS 不久成为 Xerox。Thompson 在麻省理工曾经在 IBM 7094 上为 CTSS 编写过一个 QED。他和 Ritchie 后来又在贝尔实验室为 GE-635 写了一个。现在 Thompson 为 PDP-11 写了一个简单的线性编辑器 ed。但 PDP-11 已经被用作文书处理用，所以这个文本编辑程序应该还要能把文本显示出来。

> J.E.Saltzer 曾经写过为 CTSS 写过 runoff。Doug McIlroy 回忆说：

> 我相信是 Morris 或者 Thompson 将 runoff 移植到了 635 并且改名为 roff。它是一个快速开发的东西，只用了一夜的时间。然后我用 BCPL 语言重头实现了一个简单却超越 runoff 的 roff。那成为 Thompson 和 Ritchie 在 Unix 上实现 (用机器语言) 的样本。

McIlroy 后来写信给我说：“Ken 已经不记得 635 上面的 roff，因此我猜测他其实并没有参与 roff 的开发。然而他记得他曾大概在 Unix 之前为 PDP-7 写过一个叫 rf 的小程序”。这看起来有些矛盾，后来又“猜测”是 Ritchie 实现了它。

Ritchie 说“我知道有一个骗局正在发生，我们承诺了一个文本处理系统，而不是一个操作系统”。但文本处理的努力付出是成功的：贝尔实验室的法务部门和研究小组共享 PDP-11/20，成为第一个 Unix 用户。更为重要的是，实验室的法务部门随后接管了运行 Unix 的 11/20，并且给计算机研究小组拨款购买了 PDP-11/45。
